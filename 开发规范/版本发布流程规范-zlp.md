# 版本发布流程规范

| 版本 | 修订时间   | 修订人 | 备注     |
| ---- | ---------- | ------ | -------- |
| V1.0 | 2017-04-24 | 李超超 | 初稿     |
| V1.0 | 2017-04-24 | 郑兆嘉 | 初稿修订 |

[TOC]

## 1. Git 分支管理

### 1.1 分支定义

- `master` **正式分支**  
  master 分支的代码必须跟生产环境的代码完全一致， 这个分支只能从 release 分支合并，不能在这个分支直接修改。

      每次新建 `特性/hotfix` 分支必须从 最新的 master 分支上创建。每次 master 代码更新要附加 `Tag`。

- `release` **预发布分支**  
   预发布用于本次迭代任务发布，用于合并通过测试的`develop`分支。此分支目的用于汇总当期发版的分支及代码 review。
- `develop` **测试分支**  
   提测用的分支，特性/bug 开发完后把分支推到远程，然后合并到 develop 分支，代码自动提交到测试服务器进行测试。

- `hotfix` **特性分支**  
   开发新特性或者修复 bug 用，按照固定命名规则(v1.1-hotfix-需求关联号-描述)

### 1.2 hotfix 分支示例

如修复某登录相关的 bug ：

1. 先更新 git 远程源 ：`git fetch origin`
2. 在 `master` 上建立新分支 ： `git checkout -b v1.1-hotfix-101-login origin/master `
3. 开发并自测后将该分支推送到远程 : `git push -u origin v1.1-hotfix-101-login `
4. 合并代码到 `develop`，然后再 Gitlab 中申请`代码合并(request pull)`到 `develop`，合并刚才提交的分支 `v1.1-hotfix-101-login` 到 `develop`, 代码自动更新到测试服务器，然后提测(提测过程中发现有问题的打回修复，直接在刚申请的 v1.1-hotfix-101-login 分支上修复，修复完重新走上述流程)。
5. 申请代码合并(request pull)：测试通过后，按照`步骤4`，合并请求刚才提交的 hotfix 分支`v1.1-hotfix-101-login` 到 `release`分支，等待发版人 Review 后进行版本发布。
6. 合并确认：发版人通过查看 Gitlab 中的`release`合并申请，与`v1.1-hotfix-101-login`分支的合并申请人进行代码 Review ，确认没问题后把本次发版的各分支（每次发版可能会有不同的分支合并申请，有特性开发的也有 bug 修复的）全合并到 `release`。
7. 代码 Review：发版人确认本次发版的所有分支合并到 release 无误且合并无冲突后，在 Gitlab 上发起合并 `release` 到 `master` 申请，发起后 Gitlab 会弹出一个`code diff`页面(即本次发版的所有代码差异)，发到开发群让各平台组员进行代码 review，每个人都要参加代码 review，确认没问题的在评论上留言 `ok`，有问题的在响应代码处评论指出问题。

### 1.3 注意

1. 分支建立没有限制，不用担心分支建立太多的问题。
2. 历史分支确认无用后可删除，删除了 master 等分支还是有相应记录的。
3. 发现申请合并有冲突，一般先把最新的`master`合并到当前开发分支解决掉冲突再申请即可。
4. 代码合并到 `master` `release` `develop` 这个三个分支必须通过 Gitlab 提合并申请，否则容易出现冲突及异常。
5. 每次建立新分支或推到远程时记得先合并(git merge master)最新的`master`分支，可以最大限度减少冲突。
6. 每次 `master` 发布时，记得打上版本号（tag）。
